{"version":3,"names":["_constants","require","_schema","_createCreateTableQuery","sqlite","QuickSQLite","e","isRemoteDebuggerError","Error","message","includes","QuickSqliteClient","_createClass2","_classCallCheck2","exports","dbVersion","dbName","DB_NAME","dbLocation","DB_LOCATION","getDbVersion","setDbVersion","version","openDB","open","execute","logger","error","console","closeDB","close","executeSqlBatch","queries","length","executeBatch","executeSql","query","params","_sqlite$execute","rows","_array","dropTables","Object","keys","tables","map","table","deleteDatabase","dbname","initializeDatabase","undefined","getUserPragmaVersion","updateUserPragmaVersion","q","reduce","queriesSoFar","tableName","push","apply","_toConsumableArray2","createCreateTableQuery","_sqlite$execute2","result","user_version","resetDB"],"sources":["QuickSqliteClient.ts"],"sourcesContent":["/* eslint-disable no-underscore-dangle */\nimport type { QuickSQLite } from 'react-native-quick-sqlite';\nlet sqlite: typeof QuickSQLite;\n\ntry {\n  sqlite = require('react-native-quick-sqlite').QuickSQLite;\n} catch (e) {\n  // We want to throw the original error when remote debugger (e.g. Chrome) is enabled.\n  // QuickSQLite can only be used when synchronous method invocations (JSI) are possible.\n  // e.g on-device debugger (e.g. Flipper).\n  const isRemoteDebuggerError = e instanceof Error && e.message.includes('Failed to install');\n  if (isRemoteDebuggerError) {\n    throw e;\n  }\n  // Reaching here will mean that QuickSQLite is not installed for one of the reasons\n  // 1. Running on regular expo, where we don't support offline storage yet.\n  // 2. Offline support is disabled, in which case this library is not installed.\n}\n\nimport { Logger } from 'stream-chat';\n\nimport { DB_LOCATION, DB_NAME } from './constants';\nimport { tables } from './schema';\nimport { createCreateTableQuery } from './sqlite-utils/createCreateTableQuery';\nimport type { PreparedQueries, Table } from './types';\n\n/**\n * QuickSqliteClient takes care of any direct interaction with sqlite.\n * This way usage react-native-quick-sqlite package is scoped to a single class/file.\n *\n */\nexport class QuickSqliteClient {\n  static dbVersion = 3;\n\n  static dbName = DB_NAME;\n  static dbLocation = DB_LOCATION;\n  static logger: Logger | undefined;\n\n  static getDbVersion = () => QuickSqliteClient.dbVersion;\n  // Force a specific db version. This is mainly useful for testsuit.\n  static setDbVersion = (version: number) => (QuickSqliteClient.dbVersion = version);\n\n  static openDB = () => {\n    try {\n      sqlite.open(QuickSqliteClient.dbName, QuickSqliteClient.dbLocation);\n      sqlite.execute(QuickSqliteClient.dbName, `PRAGMA foreign_keys = ON`, []);\n    } catch (e) {\n      this.logger?.('error', `Error opening database ${QuickSqliteClient.dbName}`, {\n        error: e,\n      });\n      console.error(`Error opening database ${QuickSqliteClient.dbName}: ${e}`);\n    }\n  };\n\n  static closeDB = () => {\n    try {\n      sqlite.close(QuickSqliteClient.dbName);\n    } catch (e) {\n      this.logger?.('error', `Error closing database ${QuickSqliteClient.dbName}`, {\n        error: e,\n      });\n      console.error(`Error closing database ${QuickSqliteClient.dbName}: ${e}`);\n    }\n  };\n\n  static executeSqlBatch = (queries: PreparedQueries[]) => {\n    if (!queries || !queries.length) return;\n\n    QuickSqliteClient.openDB();\n    try {\n      sqlite.executeBatch(DB_NAME, queries);\n\n      QuickSqliteClient.closeDB();\n    } catch (e) {\n      QuickSqliteClient.closeDB();\n      this.logger?.('error', `SqlBatch queries failed`, {\n        error: e,\n        queries,\n      });\n      throw new Error(`Queries failed: ${e}`);\n    }\n  };\n\n  static executeSql = (query: string, params?: string[]) => {\n    try {\n      QuickSqliteClient.openDB();\n      const { rows } = sqlite.execute(DB_NAME, query, params);\n      QuickSqliteClient.closeDB();\n\n      return rows ? rows._array : [];\n    } catch (e) {\n      QuickSqliteClient.closeDB();\n      this.logger?.('error', `Sql single query failed`, {\n        error: e,\n        query,\n      });\n      throw new Error(`Query failed: ${e}: `);\n    }\n  };\n\n  static dropTables = () => {\n    const queries: PreparedQueries[] = Object.keys(tables).map((table) => [\n      `DROP TABLE IF EXISTS ${table}`,\n      [],\n    ]);\n    this.logger?.('info', `Dropping tables`, {\n      tables: Object.keys(tables),\n    });\n    QuickSqliteClient.executeSqlBatch(queries);\n  };\n\n  static deleteDatabase = () => {\n    this.logger?.('info', `deleteDatabase`, {\n      dbLocation: QuickSqliteClient.dbLocation,\n      dbname: QuickSqliteClient.dbName,\n    });\n    try {\n      sqlite.delete(QuickSqliteClient.dbName, QuickSqliteClient.dbLocation);\n    } catch (e) {\n      this.logger?.('error', `Error deleting DB`, {\n        dbLocation: QuickSqliteClient.dbLocation,\n        dbname: QuickSqliteClient.dbName,\n        error: e,\n      });\n      throw new Error(`Error deleting DB: ${e}`);\n    }\n\n    return true;\n  };\n\n  static initializeDatabase = () => {\n    if (sqlite === undefined) {\n      throw new Error(\n        'Please install \"react-native-quick-sqlite\" package to enable offline support',\n      );\n    }\n\n    const version = QuickSqliteClient.getUserPragmaVersion();\n\n    if (version !== QuickSqliteClient.dbVersion) {\n      QuickSqliteClient.logger?.('info', `DB version mismatch`);\n      QuickSqliteClient.dropTables();\n      QuickSqliteClient.updateUserPragmaVersion(QuickSqliteClient.dbVersion);\n    }\n    QuickSqliteClient.logger?.('info', `create tables if not exists`, {\n      tables: Object.keys(tables),\n    });\n    const q = (Object.keys(tables) as Table[]).reduce<PreparedQueries[]>(\n      (queriesSoFar, tableName) => {\n        queriesSoFar.push(...createCreateTableQuery(tableName));\n        return queriesSoFar;\n      },\n      [],\n    );\n\n    QuickSqliteClient.executeSqlBatch(q);\n  };\n\n  static updateUserPragmaVersion = (version: number) => {\n    QuickSqliteClient.logger?.('info', `updateUserPragmaVersion to ${version}`);\n    QuickSqliteClient.openDB();\n    sqlite.execute(DB_NAME, `PRAGMA user_version = ${version}`, []);\n    QuickSqliteClient.closeDB();\n  };\n\n  static getUserPragmaVersion = () => {\n    QuickSqliteClient.openDB();\n    try {\n      const { rows } = sqlite.execute(DB_NAME, `PRAGMA user_version`, []);\n      const result = rows ? rows._array : [];\n      this.logger?.('info', `getUserPragmaVersion`, {\n        result,\n      });\n      QuickSqliteClient.closeDB();\n      return result[0].user_version as number;\n    } catch (e) {\n      QuickSqliteClient.closeDB();\n      throw new Error(`Querying for user_version failed: ${e}`);\n    }\n  };\n\n  static resetDB = () => {\n    this.logger?.('info', `resetDB`);\n    QuickSqliteClient.dropTables();\n    QuickSqliteClient.initializeDatabase();\n  };\n}\n"],"mappings":"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"}