{"version":3,"names":["_QuickSqliteClient","require","_schema","selectMessagesForChannels","cids","questionMarks","Array","length","fill","join","messagesColumnNames","Object","keys","tables","messages","columns","map","name","userColumnNames","users","QuickSqliteClient","logger","result","executeSql","r","JSON","parse","value","exports"],"sources":["selectMessagesForChannels.ts"],"sourcesContent":["import { QuickSqliteClient } from '../../QuickSqliteClient';\nimport { tables } from '../../schema';\nimport type { TableRowJoinedUser } from '../../types';\n\nexport const selectMessagesForChannels = (cids: string[]): TableRowJoinedUser<'messages'>[] => {\n  const questionMarks = Array(cids.length).fill('?').join(',');\n  const messagesColumnNames = Object.keys(tables.messages.columns)\n    .map((name) => `'${name}', a.${name}`)\n    .join(', ');\n  const userColumnNames = Object.keys(tables.users.columns)\n    .map((name) => `'${name}', b.${name}`)\n    .join(', ');\n\n  QuickSqliteClient.logger?.('info', 'selectMessagesForChannels', {\n    cids,\n  });\n\n  const result = QuickSqliteClient.executeSql(\n    `SELECT\n      json_object(\n        'user', json_object(\n          ${userColumnNames}\n        ),\n        ${messagesColumnNames}\n      ) as value\n    FROM (\n      SELECT\n        *,\n        ROW_NUMBER() OVER (\n          PARTITION BY cid\n          ORDER BY datetime(createdAt) DESC\n        ) RowNum\n      FROM messages\n      WHERE cid in (${questionMarks})\n    ) a\n    LEFT JOIN\n      users b\n    ON b.id = a.userId \n    WHERE RowNum < 200`,\n    cids,\n  );\n\n  return result.map((r: { value: string }) => JSON.parse(r.value));\n};\n"],"mappings":";;;;AAAA,IAAAA,kBAAA,GAAAC,OAAA;AACA,IAAAC,OAAA,GAAAD,OAAA;AAGO,IAAME,yBAAyB,GAAG,SAA5BA,yBAAyBA,CAAIC,IAAc,EAAuC;EAC7F,IAAMC,aAAa,GAAGC,KAAK,CAACF,IAAI,CAACG,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;EAC5D,IAAMC,mBAAmB,GAAGC,MAAM,CAACC,IAAI,CAACC,cAAM,CAACC,QAAQ,CAACC,OAAO,CAAC,CAC7DC,GAAG,CAAC,UAACC,IAAI;IAAA,aAASA,IAAI,aAAQA,IAAI;EAAA,CAAE,CAAC,CACrCR,IAAI,CAAC,IAAI,CAAC;EACb,IAAMS,eAAe,GAAGP,MAAM,CAACC,IAAI,CAACC,cAAM,CAACM,KAAK,CAACJ,OAAO,CAAC,CACtDC,GAAG,CAAC,UAACC,IAAI;IAAA,aAASA,IAAI,aAAQA,IAAI;EAAA,CAAE,CAAC,CACrCR,IAAI,CAAC,IAAI,CAAC;EAEbW,oCAAiB,CAACC,MAAM,oBAAxBD,oCAAiB,CAACC,MAAM,CAAG,MAAM,EAAE,2BAA2B,EAAE;IAC9DjB,IAAI,EAAJA;EACF,CAAC,CAAC;EAEF,IAAMkB,MAAM,GAAGF,oCAAiB,CAACG,UAAU,0EAIjCL,eAAe,8BAEjBR,mBAAmB,mOAUPL,aAAa,gGAM/BD,IACF,CAAC;EAED,OAAOkB,MAAM,CAACN,GAAG,CAAC,UAACQ,CAAoB;IAAA,OAAKC,IAAI,CAACC,KAAK,CAACF,CAAC,CAACG,KAAK,CAAC;EAAA,EAAC;AAClE,CAAC;AAACC,OAAA,CAAAzB,yBAAA,GAAAA,yBAAA"}